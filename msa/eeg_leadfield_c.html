<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<!-- saved from url=(0077)http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/src/eeg_leadfield.c.html -->
<HTML><HEAD><TITLE>msa/src/eeg_leadfield.c</TITLE>
<META http-equiv=Content-Type content="text/html; charset=windows-1252"><!-- Generated by C2Html-20.9.99, Copyright 1999 by Donna Robinson -->
<META content="MSHTML 6.00.2715.400" name=GENERATOR></HEAD>
<BODY text=#000000 bgColor=#ffffff>
<CENTER>
<H1>msa/src/eeg_leadfield.c</H1></CENTER>
<HR>
<PRE><FONT color=#0000ff>/* 
 * eeg_leadfield.c
 *
 * (c) Robert Oostenveld
 *
 */</FONT>

<FONT color=#a521f7>#include</FONT> &lt;stdio.h&gt;
<FONT color=#a521f7>#include</FONT> &lt;math.h&gt;
<FONT color=#a521f7>#include</FONT> &lt;nr.h&gt;
<FONT color=#a521f7>#include</FONT> &lt;nrutil.h&gt;
<FONT color=#a521f7>#include</FONT> <FONT color=#ff0000>"msa.h"</FONT>
<FONT color=#a521f7>#include</FONT> <FONT color=#ff0000>"vector.h"</FONT>

<FONT color=#a521f7>#ifndef</FONT> <A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/src/signal_space_projection.c.html#DEBUG">DEBUG</A>
  #define <A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/src/signal_space_projection.c.html#DEBUG">DEBUG</A> <A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/src/debug.c.html#nodebug">nodebug</A>
<FONT color=#a521f7>#endif</FONT>

<FONT color=#0000ff>/******************************************************************************
 *
 * electric leadfield matrix for a single dipole 
 *
 *   calculates the electric leadfield from a single current dipole 
 *   in a homogenous sphere or in multiple concentric spheres
 *
 *****************************************************************************/</FONT>
<FONT color=#298c52>int</FONT> <A name=eeg_leadfield_sphere>eeg_leadfield_sphere</A>(
  <FONT color=#298c52>float</FONT> *rd,			<FONT color=#0000ff>/* rd[1..3] position dipole		*/</FONT>
  <FONT color=#298c52>float</FONT> *radius,		<FONT color=#0000ff>/* radius sphere[1..Nsphere]		*/</FONT>
  <FONT color=#298c52>float</FONT> *conductivity,		<FONT color=#0000ff>/* conductivity sphere[1..Nsphere]	*/</FONT>
  <FONT color=#298c52>float</FONT> **electrode,		<FONT color=#0000ff>/* electrode[1..Nchans][1..3] in carthesian coordinates */</FONT>
  <FONT color=#298c52>float</FONT> **lf,			<FONT color=#0000ff>/* leadfield matrix is returned		*/</FONT>
  <FONT color=#298c52>int</FONT> Nspheres,			<FONT color=#0000ff>/* number of spheres			*/</FONT>
  <FONT color=#298c52>int</FONT> Nchans			<FONT color=#0000ff>/* number of electrodes			*/</FONT>
)
{
  <FONT color=#298c52>int</FONT> retval;
  <FONT color=#298c52>float</FONT> *r, *c;

  <FONT color=#298c52>if</FONT> (Nspheres==1) {
	<FONT color=#0000ff>/* here one could check if the dipole lies on the z-axis and		*/</FONT>
	<FONT color=#0000ff>/* then take the more flexible but inefficient 4 sphere calculation	*/</FONT>

	retval = <A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/src/eeg_leadfield.c.html#leadfield_sphere1">leadfield_sphere1</A>(rd, radius[1], conductivity[1], electrode, lf, Nchans);
	}

  <FONT color=#298c52>else</FONT> <FONT color=#298c52>if</FONT> (Nspheres==2) {
	<FONT color=#0000ff>/* the leadfield is calculated using the algorithm for four 	*/</FONT>
	<FONT color=#0000ff>/* concentric spheres, whereby the spheres for the liquor 	*/</FONT>
	<FONT color=#0000ff>/* brain and skull are combined to a single sphere 		*/</FONT>

	r = vector(1,4);
	c = vector(1,4);

	r[1] = radius[1];	<FONT color=#0000ff>/* brain 				*/</FONT>
	r[2] = radius[1];	<FONT color=#0000ff>/* liquor is combined with brain	*/</FONT>
	r[3] = radius[1];	<FONT color=#0000ff>/* skull				*/</FONT>
	r[4] = radius[2];	<FONT color=#0000ff>/* scalp				*/</FONT>

	c[1] = conductivity[1];	<FONT color=#0000ff>/* brain 				*/</FONT>
	c[2] = conductivity[1];	<FONT color=#0000ff>/* liquor is combined with brain	*/</FONT>
	c[3] = conductivity[1];	<FONT color=#0000ff>/* skull				*/</FONT>
	c[4] = conductivity[2];	<FONT color=#0000ff>/* scalp				*/</FONT>

	retval = <A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/src/eeg_leadfield.c.html#leadfield_sphere4">leadfield_sphere4</A>(rd, r, c, electrode, lf, Nchans);

	free_vector(r,1,4);
	free_vector(c,1,4);
	}

  <FONT color=#298c52>else</FONT> <FONT color=#298c52>if</FONT> (Nspheres==3) {
	<FONT color=#0000ff>/* the leadfield is calculated using the algorithm for four 	*/</FONT>
	<FONT color=#0000ff>/* concentric spheres, whereby the spheres for the liquor 	*/</FONT>
	<FONT color=#0000ff>/* and the brain are combined to a single sphere 		*/</FONT>

	r = vector(1,4);
	c = vector(1,4);

	r[1] = radius[1];	<FONT color=#0000ff>/* brain 				*/</FONT>
	r[2] = radius[1];	<FONT color=#0000ff>/* liquor is combined with brain	*/</FONT>
	r[3] = radius[2];	<FONT color=#0000ff>/* skull				*/</FONT>
	r[4] = radius[3];	<FONT color=#0000ff>/* scalp				*/</FONT>

	c[1] = conductivity[1];	<FONT color=#0000ff>/* brain 				*/</FONT>
	c[2] = conductivity[1];	<FONT color=#0000ff>/* liquor is combined with brain	*/</FONT>
	c[3] = conductivity[2];	<FONT color=#0000ff>/* skull				*/</FONT>
	c[4] = conductivity[3];	<FONT color=#0000ff>/* scalp				*/</FONT>

	retval = <A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/src/eeg_leadfield.c.html#leadfield_sphere4">leadfield_sphere4</A>(rd, r, c, electrode, lf, Nchans);

	free_vector(r,1,4);
	free_vector(c,1,4);
	}

  <FONT color=#298c52>else</FONT> <FONT color=#298c52>if</FONT> (Nspheres==4)
	retval = <A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/src/eeg_leadfield.c.html#leadfield_sphere4">leadfield_sphere4</A>(rd, radius, conductivity, electrode, lf, Nchans);

  <FONT color=#298c52>else</FONT> 
	<FONT color=#298c52>return</FONT> <A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/src/msa_error.c.html#msa_error">msa_error</A>(<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/include/msa_error.h.html#ERR_NSPHERE">ERR_NSPHERE</A>);

  <FONT color=#298c52>return</FONT>(retval);
}


<FONT color=#0000ff>/******************************************************************************
 *
 * electric leadfield matrix for a single dipole in a homogenous sphere
 *
 *   calculates the electric leadfield from a single current dipole 
 *   in a homogenous sphere for a set of electrodes on this sphere
 *
 * warning: 
 *   the algorithm does not work for a dipole in the origin
 *   and it does not work for an electrode on the z-axis 
 *   all matrices in the function call are stored in a NumRec style
 *   all memory should be allocated before the function call
 *
 * reference: Luetkenhoener, Habilschrift '92
 *
 *****************************************************************************/</FONT>
<FONT color=#298c52>int</FONT> <A name=leadfield_sphere1>leadfield_sphere1</A>(
  <FONT color=#298c52>float</FONT> *rd,			<FONT color=#0000ff>/* rd[1..3] position dipole		*/</FONT>
  <FONT color=#298c52>float</FONT> radius,			<FONT color=#0000ff>/* radius sphere			*/</FONT>
  <FONT color=#298c52>float</FONT> conductivity,		<FONT color=#0000ff>/* conductivity sphere			*/</FONT>
  <FONT color=#298c52>float</FONT> **electrode,		<FONT color=#0000ff>/* electrode[1..Nchans][1..3] in carthesian coordinates */</FONT>
  <FONT color=#298c52>float</FONT> **lf,			<FONT color=#0000ff>/* leadfield matrix is returned		*/</FONT>
  <FONT color=#298c52>int</FONT> Nchans			<FONT color=#0000ff>/* number of electrodes			*/</FONT>
)
{
  <FONT color=#298c52>int</FONT> i;
  <FONT color=#298c52>float</FONT> A, B, s1, s2;
  <FONT color=#298c52>float</FONT> *r, *dr, *rxR, *R, *vec1, *vec2;
  <FONT color=#298c52>float</FONT> abs_r, abs_dr, abs_rxR, abs_R;

  <FONT color=#298c52>if</FONT> (Nchans&lt;=1)
	<FONT color=#298c52>return</FONT> <A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/src/msa_error.c.html#msa_error">msa_error</A>(<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/include/msa_error.h.html#ERR_NCHANS">ERR_NCHANS</A>);
  <FONT color=#298c52>if</FONT> (radius&lt;=0)
	<FONT color=#298c52>return</FONT> <A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/src/msa_error.c.html#msa_error">msa_error</A>(<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/include/msa_error.h.html#ERR_S_RAD">ERR_S_RAD</A>);
  <FONT color=#298c52>if</FONT> (conductivity&lt;=0)
	<FONT color=#298c52>return</FONT> <A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/src/msa_error.c.html#msa_error">msa_error</A>(<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/include/msa_error.h.html#ERR_S_COND">ERR_S_COND</A>);

  <A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/include/vector.h.html#NORM_VEC">NORM_VEC</A>(&amp;(rd[1]), s1, 3, <FONT color=#298c52>float</FONT>);

  <FONT color=#298c52>if</FONT> (s1 &lt; <A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/src/msa_parameters.c.html#almost_zero">almost_zero</A>) {
	<FONT color=#0000ff>/* to avoid this annoying exception, shift the dipole to a position nearby	*/</FONT>
	<FONT color=#0000ff>/* this should be taken care of more properly!!					*/</FONT>
	fprintf(stderr, <FONT color=#ff0000>"warning: dipole is in origin \n"</FONT>);
	rd[1] = 0;
	rd[2] = 0;
	rd[3] = <A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/src/msa_parameters.c.html#almost_zero">almost_zero</A>;
  	}

  <FONT color=#298c52>for</FONT> (i=1; i&lt;=Nchans; i++) {
	<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/include/vector.h.html#NORM_VEC">NORM_VEC</A>(&amp;(electrode[i][1]), s1, 3, <FONT color=#298c52>float</FONT>);
	<FONT color=#298c52>if</FONT> (fabs(s1-radius)/radius &gt; <A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/include/msa.h.html#REL_ACCURACY">REL_ACCURACY</A>) 
		fprintf(stderr, <FONT color=#ff0000>"warning: electrode %i not on sphere\n"</FONT>, i);
	}

  R    = rd; 		<FONT color=#0000ff>/* position dipole */</FONT>
  dr   = vector(1,3);
  rxR  = vector(1,3);
  vec1 = vector(1,3);
  vec2 = vector(1,3);

  <FONT color=#298c52>for</FONT> (i=1; i&lt;=Nchans; i++) {

	<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/src/signal_space_projection.c.html#DEBUG">DEBUG</A>(<FONT color=#ff0000>"leadfield_sphere1: calculating electrode %i\n"</FONT>, i);

	r = electrode[i];	<FONT color=#0000ff>/* position electrode (carthesian coordinates)	*/</FONT>

  	<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/include/vector.h.html#NORM_VEC">NORM_VEC</A>(&amp;(r[1]), abs_r, 3, <FONT color=#298c52>float</FONT>);

	<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/include/vector.h.html#SUB_VEC">SUB_VEC</A>(&amp;(r[1]), &amp;(R[1]), &amp;(dr[1]), 3, <FONT color=#298c52>float</FONT>, <FONT color=#298c52>float</FONT>, <FONT color=#298c52>float</FONT>);
	<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/include/vector.h.html#CROSSP_VEC">CROSSP_VEC</A>(&amp;(r[1]), &amp;(R[1]), &amp;(rxR[1]), <FONT color=#298c52>float</FONT>, <FONT color=#298c52>float</FONT>, <FONT color=#298c52>float</FONT>);

	<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/src/signal_space_projection.c.html#DEBUG">DEBUG</A>(<FONT color=#ff0000>"R  = %f %f %f\n"</FONT>, R[1], R[2], R[3]);
	<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/src/signal_space_projection.c.html#DEBUG">DEBUG</A>(<FONT color=#ff0000>"dr = %f %f %f\n"</FONT>, dr[1], dr[2], dr[3]);

	<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/include/vector.h.html#NORM_VEC">NORM_VEC</A>(&amp;(R[1]), abs_R, 3, <FONT color=#298c52>float</FONT>);
	<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/include/vector.h.html#NORM_VEC">NORM_VEC</A>(&amp;(dr[1]), abs_dr, 3, <FONT color=#298c52>float</FONT>);
	<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/include/vector.h.html#NORM_VEC">NORM_VEC</A>(&amp;(rxR[1]), abs_rxR, 3, <FONT color=#298c52>float</FONT>);

	s1 = abs_dr*abs_dr*abs_dr;
	s2 = abs_R*abs_R;

	<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/src/signal_space_projection.c.html#DEBUG">DEBUG</A>(<FONT color=#ff0000>"s1 = %f, s2 = %f\n"</FONT>, s1, s2);
	<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/src/signal_space_projection.c.html#DEBUG">DEBUG</A>(<FONT color=#ff0000>"abs_rxR = %f\n"</FONT>, abs_rxR);

	<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/include/vector.h.html#SCALE_VEC">SCALE_VEC</A>(&amp;(r[1]), &amp;(vec1[1]), 1.0/abs_r, 3, <FONT color=#298c52>float</FONT>, <FONT color=#298c52>float</FONT>);
	<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/include/vector.h.html#SCALE_VEC">SCALE_VEC</A>(&amp;(dr[1]), &amp;(vec2[1]), 1.0/abs_dr, 3, <FONT color=#298c52>float</FONT>, <FONT color=#298c52>float</FONT>);
	<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/include/vector.h.html#SUB1_VEC">SUB1_VEC</A>(&amp;(vec1[1]), &amp;(vec2[1]), 3, <FONT color=#298c52>float</FONT>, <FONT color=#298c52>float</FONT>);
	<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/include/vector.h.html#DOTP_VEC">DOTP_VEC</A>(&amp;(vec1[1]), &amp;(R[1]), A, 3, <FONT color=#298c52>float</FONT>, <FONT color=#298c52>float</FONT>);

	<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/src/signal_space_projection.c.html#DEBUG">DEBUG</A>(<FONT color=#ff0000>"A = %f\n"</FONT>, A);
	A /= abs_rxR*abs_rxR;
	<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/src/signal_space_projection.c.html#DEBUG">DEBUG</A>(<FONT color=#ff0000>"A = %f\n"</FONT>, A);
	A += 2/s1;
	<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/src/signal_space_projection.c.html#DEBUG">DEBUG</A>(<FONT color=#ff0000>"A = %f\n"</FONT>, A);

	B  = (abs_r*abs_r - s2)/s1 - 1/abs_r;
	<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/src/signal_space_projection.c.html#DEBUG">DEBUG</A>(<FONT color=#ff0000>"A = %f, B = %f\n"</FONT>, A, B);

	<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/include/vector.h.html#CROSSP_VEC">CROSSP_VEC</A>(&amp;(R[1]), &amp;(rxR[1]), &amp;(vec1[1]), <FONT color=#298c52>float</FONT>, <FONT color=#298c52>float</FONT>, <FONT color=#298c52>float</FONT>);
	<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/include/vector.h.html#SCALE_VEC">SCALE_VEC</A>(&amp;(vec1[1]), &amp;(vec1[1]), A, 3, <FONT color=#298c52>float</FONT>, <FONT color=#298c52>float</FONT>);
	<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/include/vector.h.html#SCALE_VEC">SCALE_VEC</A>(&amp;(R[1]), &amp;(vec2[1]), B, 3, <FONT color=#298c52>float</FONT>, <FONT color=#298c52>float</FONT>);

	<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/include/vector.h.html#ADD1_VEC">ADD1_VEC</A>(&amp;(vec1[1]), &amp;(vec2[1]), 3, <FONT color=#298c52>float</FONT>, <FONT color=#298c52>float</FONT>);
	<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/include/vector.h.html#SCALE_VEC">SCALE_VEC</A>(&amp;(vec1[1]), &amp;(lf[i][1]), 1/(4*<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/include/msa.h.html#M_PI">M_PI</A>*conductivity*s2), 3, <FONT color=#298c52>float</FONT>, <FONT color=#298c52>float</FONT>);

	}

  free_vector(dr,1,3);
  free_vector(rxR,1,3);
  free_vector(vec1,1,3);
  free_vector(vec2,1,3);
  <A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/src/signal_space_projection.c.html#DEBUG">DEBUG</A>(<FONT color=#ff0000>"leadfield_sphere1: ready\n"</FONT>);
  <FONT color=#298c52>return</FONT>(0);
}



<FONT color=#0000ff>/******************************************************************************
 *
 * electric leadfield matrix for a single dipole in four concentric spheres
 *
 * warning: 
 *   all matrices in the function call are stored in a NumRec style
 *   all memory should be allocated before the function call
 *
 * reference: Luetkenhoener, Habilschrift '92
 *
 *****************************************************************************/</FONT>
<FONT color=#298c52>int</FONT> <A name=leadfield_sphere4>leadfield_sphere4</A>(
  <FONT color=#298c52>float</FONT> *rd,			<FONT color=#0000ff>/* rd[1..3] position dipole		*/</FONT>
  <FONT color=#298c52>float</FONT> *radius,		<FONT color=#0000ff>/* radius sphere[1..4]			*/</FONT>
  <FONT color=#298c52>float</FONT> *conductivity,		<FONT color=#0000ff>/* conductivity sphere[1..4]		*/</FONT>
  <FONT color=#298c52>float</FONT> **electrode,		<FONT color=#0000ff>/* electrode[1..Nchans][1..3] in carthesian coordinates */</FONT>
  <FONT color=#298c52>float</FONT> **lf,			<FONT color=#0000ff>/* leadfield matrix is returned		*/</FONT>
  <FONT color=#298c52>int</FONT> Nchans			<FONT color=#0000ff>/* number of electrodes			*/</FONT>
)
{
  <FONT color=#298c52>int</FONT> i, j, n;
  <FONT color=#298c52>float</FONT> *sph, **A, **Atr, R, excentricity, val;
  <FONT color=#298c52>float</FONT> r, phi, theta, cos_theta;
  <FONT color=#298c52>int</FONT> exp;			<FONT color=#0000ff>/* these are dummies */</FONT>
  <FONT color=#298c52>float</FONT> o12, o23, o34, C;	<FONT color=#0000ff>/* these are dummies */</FONT>

  <FONT color=#298c52>if</FONT> (Nchans&lt;=1)
	  <FONT color=#298c52>return</FONT> <A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/src/msa_error.c.html#msa_error">msa_error</A>(<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/include/msa_error.h.html#ERR_NCHANS">ERR_NCHANS</A>);

  sph = vector(1,3);
  A   = matrix(1,3,1,3);	<FONT color=#0000ff>/* rotation matrix 						*/</FONT>
  Atr = matrix(1,3,1,3);	<FONT color=#0000ff>/* inverse rotation matrix, which equals transposed matrix	*/</FONT>

  <FONT color=#0000ff>/* the dipole and electrode positions are rotated, such that the dipole	*/</FONT>
  <FONT color=#0000ff>/* position is on the z-axis (0,0,R). After calculation of the leadfield	*/</FONT>
  <FONT color=#0000ff>/* matrix, this matrix undergoes the backward coordinate transformation	*/</FONT>

  <FONT color=#0000ff>/* this is not the most efficient: it would be easier (and faster) to leave 	*/</FONT>
  <FONT color=#0000ff>/* leadfield matrix as it is and rotate the dipole moment, which is only a 	*/</FONT>
  <FONT color=#0000ff>/* vector instead of a matrix, before the potential is calculated		*/</FONT>

  <A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/src/signal_space_projection.c.html#DEBUG">DEBUG</A>(<FONT color=#ff0000>"leadfield_sphere4: calculating rotation matrix (%f,%f,%f)\n"</FONT>, rd[1], rd[2], rd[3]);

  <A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/include/vector.h.html#NORM_VEC">NORM_VEC</A>(&amp;(rd[1]), R, 3, <FONT color=#298c52>float</FONT>);

  <FONT color=#298c52>if</FONT> (R &lt; <A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/src/msa_parameters.c.html#almost_zero">almost_zero</A>) {
	<FONT color=#0000ff>/* to avoid this annoying exception, shift the dipole to a position nearby	*/</FONT>
	<FONT color=#0000ff>/* this should be taken care of more properly!!					*/</FONT>
	fprintf(stderr, <FONT color=#ff0000>"warning: dipole is in origin \n"</FONT>);
	rd[1] = 0;
	rd[2] = 0;
	rd[3] = <A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/src/msa_parameters.c.html#almost_zero">almost_zero</A>;
  	}

  <FONT color=#0000ff>/* for a dipole in the origin I currently (981112) believe that the      */</FONT>
  <FONT color=#0000ff>/* leadfield is the same to a single sphere leadfield, so that function  */</FONT>
  <FONT color=#0000ff>/* could be called here instead (but it regretfully also does not work   */</FONT>
  <FONT color=#0000ff>/* for a dipole in the origin currently) */</FONT>

  val = sqrt(rd[1]*rd[1] + rd[2]*rd[2]);

  <FONT color=#298c52>if</FONT> (val &lt; <A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/src/msa_parameters.c.html#almost_zero">almost_zero</A> &amp;&amp; rd[3]&gt;0) {
	<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/src/signal_space_projection.c.html#DEBUG">DEBUG</A>(<FONT color=#ff0000>"leadfield_sphere4: no rotation of dipole towards z-axis neccesary\n"</FONT>);

	<FONT color=#298c52>for</FONT> (i=1; i&lt;=3; i++)
	<FONT color=#298c52>for</FONT> (j=1; j&lt;=3; j++) 
		A[i][j] = Atr[i][j] = (i==j);

	}
  <FONT color=#298c52>else</FONT> <FONT color=#298c52>if</FONT> (val &lt; <A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/src/msa_parameters.c.html#almost_zero">almost_zero</A> &amp;&amp; rd[3]&lt;0) {
	<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/src/signal_space_projection.c.html#DEBUG">DEBUG</A>(<FONT color=#ff0000>"leadfield_sphere4: 180 deg. rotation of dipole towards z-axis neccesary\n"</FONT>);

	<FONT color=#0000ff>/* rotate around x-axis	*/</FONT>

	A[1][1] = Atr[1][1] = 1;
	A[1][2] = Atr[2][1] = 0;
	A[1][3] = Atr[3][1] = 0;

	A[2][1] = Atr[1][2] = 0;
	A[2][2] = Atr[2][2] = -1;
	A[2][3] = Atr[3][2] = 0;

	A[3][1] = Atr[1][3] = 0;
	A[3][2] = Atr[2][3] = 0;
	A[3][3] = Atr[3][3] = -1;
	}
  <FONT color=#298c52>else</FONT> {
	<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/src/signal_space_projection.c.html#DEBUG">DEBUG</A>(<FONT color=#ff0000>"leadfield_sphere4: rotating dipole towards z-axis\n"</FONT>);

	A[1][1] = Atr[1][1] = rd[1] * rd[3] / (R * val); 
	A[1][2] = Atr[2][1] = rd[2] * rd[3] / (R * val);
	A[1][3] = Atr[3][1] = -1.0 * val / R;

	A[2][1] = Atr[1][2] = -1.0 * rd[2] / val;
	A[2][2] = Atr[2][2] =        rd[1] / val;
	A[2][3] = Atr[3][2] =                  0; 

	A[3][1] = Atr[1][3] = rd[1] / R;
	A[3][2] = Atr[2][3] = rd[2] / R;
	A[3][3] = Atr[3][3] = rd[3] / R;
	}

  <A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/src/signal_space_projection.c.html#DEBUG">DEBUG</A>(<FONT color=#ff0000>"leadfield_sphere4: A = %f %f %f\n"</FONT>, A[1][1], A[1][2], A[1][3]);
  <A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/src/signal_space_projection.c.html#DEBUG">DEBUG</A>(<FONT color=#ff0000>"leadfield_sphere4:     %f %f %f\n"</FONT>, A[2][1], A[2][2], A[2][3]);
  <A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/src/signal_space_projection.c.html#DEBUG">DEBUG</A>(<FONT color=#ff0000>"leadfield_sphere4:     %f %f %f\n"</FONT>, A[3][1], A[3][2], A[3][3]);

  excentricity = R / radius[4];

  <A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/src/signal_space_projection.c.html#DEBUG">DEBUG</A>(<FONT color=#ff0000>"leadfield_sphere4: excentricity = %f\n"</FONT>, excentricity);

  <FONT color=#298c52>for</FONT> (i=1; i&lt;=Nchans; i++) {
	<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/src/signal_space_projection.c.html#DEBUG">DEBUG</A>(<FONT color=#ff0000>"leadfield_sphere4: calculating leadfield for electrode %i\n"</FONT>, i);

	<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/include/vector.h.html#NORM_VEC">NORM_VEC</A>(&amp;(electrode[i][1]), r, 3, <FONT color=#298c52>float</FONT>);
	<FONT color=#298c52>if</FONT> (fabs(r-radius[4])/radius[4] &gt; <A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/include/msa.h.html#REL_ACCURACY">REL_ACCURACY</A>)
		fprintf(stderr, <FONT color=#ff0000>"warning: electrode %i not on outer sphere (%f, %f)\n"</FONT>, i, r, radius[4]);
	
	<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/include/vector.h.html#SET_VEC">SET_VEC</A>(&amp;(lf[i][1]), 0, 3, <FONT color=#298c52>float</FONT>, <FONT color=#298c52>float</FONT>);

	<FONT color=#0000ff>/* rotate electrode position using matrix multiplication (x,y,z)' = A * (x,y,z) */</FONT>

	<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/include/vector.h.html#DOTP_VEC">DOTP_VEC</A>(&amp;(A[1][1]), &amp;(electrode[i][1]), sph[1], 3, <FONT color=#298c52>float</FONT>, <FONT color=#298c52>float</FONT>);
	<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/include/vector.h.html#DOTP_VEC">DOTP_VEC</A>(&amp;(A[2][1]), &amp;(electrode[i][1]), sph[2], 3, <FONT color=#298c52>float</FONT>, <FONT color=#298c52>float</FONT>);
	<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/include/vector.h.html#DOTP_VEC">DOTP_VEC</A>(&amp;(A[3][1]), &amp;(electrode[i][1]), sph[3], 3, <FONT color=#298c52>float</FONT>, <FONT color=#298c52>float</FONT>);

	<FONT color=#0000ff>/*
	 * calculate the position of the electrode in conventional spherical coordinates:
	 *	(r, phi, theta) =  (radius, angle from x-axis, angle from z-axis)
	 * 
	 * an alternative spherical coordinate system which is also used in the msa library 
	 * for example in sph2cart and cart2sph is:
	 *	(az, el, r) = (azimult/angle from x-axis, elevation/angle from xy-plane, radius)
	 */</FONT>

	<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/src/coordinate_transformation.c.html#cart2sph">cart2sph</A>(sph, sph);
	r     = sph[3];
	phi   = sph[1];
	theta = <A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/include/msa.h.html#M_PI_2">M_PI_2</A> - sph[2];

	cos_theta  = cos(theta);

	<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/src/signal_space_projection.c.html#DEBUG">DEBUG</A>(<FONT color=#ff0000>"leadfield_sphere4: r = %f, phi = %f, theta = %f\n"</FONT>, r, phi, theta);
	<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/src/signal_space_projection.c.html#DEBUG">DEBUG</A>(<FONT color=#ff0000>"leadfield_sphere4: theta = %g, cos_theta = %g\n"</FONT>, theta, cos_theta);

	j   = 0;
	n   = 0;

	<FONT color=#0000ff>/* calculate summation term of x and y-component of leadfield */</FONT>

	<FONT color=#298c52>do</FONT> {
		n++;

		<FONT color=#0000ff>/* of course this could be much more efficient...	*/</FONT>
		<FONT color=#0000ff>/* ... but it is nice enough that it works!		*/</FONT>
	
		exp = 2*n+1;
		o12 = conductivity[1]/conductivity[2];
		o23 = conductivity[2]/conductivity[3];
		o34 = conductivity[3]/conductivity[4];

		C = ((n*o12+n+1)*(n*o23+n+1)+n*(n+1)*(o12-1)*(o23-1)*pow(radius[1]/radius[2],exp))* 
			((n*o34+n+1)+(n+1)*(o34-1)*(pow(radius[3]/radius[4],exp))) 
			+((o12-1)*((n+1)*o23+n)*pow(radius[1]/radius[3],2*n+1)+(n*o12+n+1)*(o23-1)*pow(radius[2]/radius[3],exp))* 
			(n+1)*(n*(o34-1)+((n+1)*o34+n)*pow(radius[3]/radius[4],exp));

		val = (pow(2*n+1, 4) / (n*C)) * pow(excentricity, n-1) * plgndr(n, 1, cos_theta); 
		lf[i][1] += val;


		<FONT color=#298c52>if</FONT> (fabs(val)&lt;<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/include/msa.h.html#EPS">EPS</A> || fabs(val/lf[i][1]) &lt; <A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/src/msa_parameters.c.html#plgndr_accuracy">plgndr_accuracy</A>)
			j++;
		<FONT color=#298c52>else</FONT> j = 0;

		<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/src/signal_space_projection.c.html#DEBUG">DEBUG</A>(<FONT color=#ff0000>"leadfield_sphere4: n = %i, j = %i, C = %g, val = %g, lf = %g\n"</FONT>, n, j, C, val, lf[i][1]);
		
		} <FONT color=#298c52>while</FONT> ((n &lt; <A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/src/msa_parameters.c.html#plgndr_ntot">plgndr_ntot</A>) &amp;&amp; (j &lt; <A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/src/msa_parameters.c.html#plgndr_nval">plgndr_nval</A>));

	<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/src/signal_space_projection.c.html#DEBUG">DEBUG</A>(<FONT color=#ff0000>"leadfield_sphere4: %i terms needed for convergence of x/y-val\n"</FONT>, n);

	j   = 0;
	n   = 0;

	<FONT color=#0000ff>/* calculate summation term of z-component of leadfield */</FONT>

	<FONT color=#298c52>do</FONT> {
		n++;

		<FONT color=#0000ff>/* of course this could be much more efficient...	*/</FONT>
		<FONT color=#0000ff>/* ... but it is nice enough that it works!		*/</FONT>
	
		exp = 2*n+1;
		o12 = conductivity[1]/conductivity[2];
		o23 = conductivity[2]/conductivity[3];
		o34 = conductivity[3]/conductivity[4];

		C = ((n*o12+n+1)*(n*o23+n+1)+n*(n+1)*(o12-1)*(o23-1)*pow(radius[1]/radius[2],exp))* 
			((n*o34+n+1)+(n+1)*(o34-1)*(pow(radius[3]/radius[4],exp))) 
			+((o12-1)*((n+1)*o23+n)*pow(radius[1]/radius[3],2*n+1)+(n*o12+n+1)*(o23-1)*pow(radius[2]/radius[3],exp))* 
			(n+1)*(n*(o34-1)+((n+1)*o34+n)*pow(radius[3]/radius[4],exp));

		val = (pow(2*n+1, 4) / C) * pow(excentricity, n-1) * plgndr(n, 0, cos_theta);
		lf[i][3] += val;

		<FONT color=#298c52>if</FONT> (fabs(val)&lt;<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/include/msa.h.html#EPS">EPS</A> || fabs(val/lf[i][1])&lt;<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/src/msa_parameters.c.html#plgndr_accuracy">plgndr_accuracy</A>)
			j++;
		<FONT color=#298c52>else</FONT> j = 0;

		<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/src/signal_space_projection.c.html#DEBUG">DEBUG</A>(<FONT color=#ff0000>"leadfield_sphere4: n = %i, j = %i, C = %g, val = %g, lf = %g\n"</FONT>, n, j, C, val, lf[i][3]);

		} <FONT color=#298c52>while</FONT> ((n &lt; <A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/src/msa_parameters.c.html#plgndr_ntot">plgndr_ntot</A>) &amp;&amp; (j &lt; <A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/src/msa_parameters.c.html#plgndr_nval">plgndr_nval</A>));

	<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/src/signal_space_projection.c.html#DEBUG">DEBUG</A>(<FONT color=#ff0000>"leadfield_sphere4: %i terms needed for convergence of z-val\n"</FONT>, n);


	lf[i][3] /= 4*<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/include/msa.h.html#M_PI">M_PI</A>*conductivity[4]*radius[4]*radius[4];
	lf[i][2]  =  sin(phi)/(4*<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/include/msa.h.html#M_PI">M_PI</A>*conductivity[4]*radius[4]*radius[4]) * lf[i][1]; 
	lf[i][1] *=  cos(phi)/(4*<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/include/msa.h.html#M_PI">M_PI</A>*conductivity[4]*radius[4]*radius[4]); 

<FONT color=#0000ff>/* this is strange -&gt; signs need correction */</FONT>
	lf[i][1] *= -1;
	lf[i][2] *= -1;
	lf[i][3] *=  1;

	<FONT color=#0000ff>/* rotate leadfield back using matrix multiplication (x,y,z) = Atr * (x,y,z)'	*/</FONT>
	<FONT color=#0000ff>/* vector sph[1..3] is used to store temporary result				*/</FONT>

	<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/src/signal_space_projection.c.html#DEBUG">DEBUG</A>(<FONT color=#ff0000>"leadfield_sphere4: lf before rotation = %f %f %f\n"</FONT>, lf[i][1], lf[i][2], lf[i][3]);

	<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/include/vector.h.html#DOTP_VEC">DOTP_VEC</A>(&amp;(Atr[1][1]), &amp;(lf[i][1]), sph[1], 3, <FONT color=#298c52>float</FONT>, <FONT color=#298c52>float</FONT>);
	<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/include/vector.h.html#DOTP_VEC">DOTP_VEC</A>(&amp;(Atr[2][1]), &amp;(lf[i][1]), sph[2], 3, <FONT color=#298c52>float</FONT>, <FONT color=#298c52>float</FONT>);
	<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/include/vector.h.html#DOTP_VEC">DOTP_VEC</A>(&amp;(Atr[3][1]), &amp;(lf[i][1]), sph[3], 3, <FONT color=#298c52>float</FONT>, <FONT color=#298c52>float</FONT>);
	<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/include/vector.h.html#CP_VEC">CP_VEC</A>(&amp;(sph[1]), &amp;(lf[i][1]), 3, <FONT color=#298c52>float</FONT>, <FONT color=#298c52>float</FONT>);

	<A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/src/signal_space_projection.c.html#DEBUG">DEBUG</A>(<FONT color=#ff0000>"leadfield_sphere4: lf after rotation  = %f %f %f\n"</FONT>, lf[i][1], lf[i][2], lf[i][3]);

	} <FONT color=#0000ff>/* leadfield has been calculated for this electrode */</FONT>

  free_vector(sph,1,3);
  free_matrix(A,1,3,1,3);
  free_matrix(Atr,1,3,1,3);
  <A href="http://www.mbfys.kun.nl/mbfys/people/roberto/msa/doc/src/signal_space_projection.c.html#DEBUG">DEBUG</A>(<FONT color=#ff0000>"leadfield_sphere4: ready\n"</FONT>);
  <FONT color=#298c52>return</FONT>(0);
};


</PRE></BODY></HTML>
